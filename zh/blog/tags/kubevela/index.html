<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="KubeVela Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="KubeVela Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;kubevela&quot; | KubeVela</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;kubevela&quot; | KubeVela"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;kubevela&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;kubevela&quot;"><meta data-react-helmet="true" property="og:url" content="https://kubevela.io/zh/blog/tags/kubevela"><meta data-react-helmet="true" name="docusaurus_locale" content="zh"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" property="og:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kubevela.io/zh/blog/tags/kubevela"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog/tags/kubevela" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/zh/blog/tags/kubevela" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog/tags/kubevela" hreflang="x-default"><link rel="stylesheet" href="/zh/assets/css/styles.1d69bae9.css">
<link rel="preload" href="/zh/assets/js/styles.3f20afd4.js" as="script">
<link rel="preload" href="/zh/assets/js/runtime~main.53cad828.js" as="script">
<link rel="preload" href="/zh/assets/js/main.df960407.js" as="script">
<link rel="preload" href="/zh/assets/js/1.89bb97b5.js" as="script">
<link rel="preload" href="/zh/assets/js/2.462ea471.js" as="script">
<link rel="preload" href="/zh/assets/js/3.d316d69f.js" as="script">
<link rel="preload" href="/zh/assets/js/6875c492.8f6bf776.js" as="script">
<link rel="preload" href="/zh/assets/js/34dd6e82.7ede88ae.js" as="script">
<link rel="preload" href="/zh/assets/js/111d754a.48e6ce57.js" as="script">
<link rel="preload" href="/zh/assets/js/33713896.81b19419.js" as="script">
<link rel="preload" href="/zh/assets/js/dcd7855b.5fbb5881.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/">v1.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">v1.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/kubevela" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh/blog/tags/kubevela" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li><li><a class="dropdown__link" href="/zh/blog/kubevela-official-documentation-translation-event">Help Us Translate</a></li></ul></div><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-githab-link"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">v1.0</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">文档</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/zh/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog/tags/kubevela" target="_self" rel="noopener noreferrer" class="menu__link">English</a></li><li class="menu__list-item"><a href="/zh/blog/tags/kubevela" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active">简体中文</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/blog/kubevela-official-documentation-translation-event">Help Us Translate</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="menu__link header-githab-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/kubevela-official-documentation-translation-event">KubeVela 官方文档翻译活动</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/extend-kubevela-by-cuelang-in-20-mins">如何在 20 分钟内给你的 K8s PaaS 上线一个新功能</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;kubevela&quot;</h1><a href="/zh/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/zh/blog/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎</a></h2><div class="margin-vert--md"><time datetime="2021-04-30T02:06:04.272Z" class="blogPostDate_fNvV">April 30, 2021 · One min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/resouer" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/1701782?s=200&amp;v=4" alt="Lei Zhang and Fei Guo"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/resouer" target="_blank" rel="noopener noreferrer">Lei Zhang and Fei Guo</a></h4><small class="avatar__subtitle">CNCF TOC Member/Kubernetes</small></div></div></header><div class="markdown"><blockquote><p>2020年12月7日 12:33, by Lei Zhang and Fei Guo</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg" alt="image"></p><p>美国西部时间 2020 年 11 月 18 日，在云原生技术“最高盛宴”的 KubeCon 北美峰会 2020 上，CNCF 应用交付领域小组（CNCF SIG App Delivery) 与 Open Application Model (OAM) 社区，以及来自阿里云、微软云的 OAM 项目维护者们在演讲中共同宣布了 KubeVela 开源项目的正式发布。</p><p>从 11 月 18 号到 20 号，在为期三天的 KubeCon 北美峰会上有连续 3 场技术演讲，会从不同维度介绍关于 KubeVela 项目的具体细节，其中还包括一个长达 1 个半小时的 KubeVela 互动教学环节。多个重量级组织以如此规模和密度在 KubeCon 北美峰会演讲中介绍一个首次发布的社区开源项目，在 KubeCon 诞生以来并不多见。</p><p>KubeVela Github 地址：<a href="https://github.com/oam-dev/kubevela/" target="_blank" rel="noopener noreferrer">https://github.com/oam-dev/kubevela/</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="什么是-kubevela-？"></a>什么是 KubeVela ？<a class="hash-link" href="#什么是-kubevela-？" title="Direct link to heading">#</a></h2><p>一言以蔽之，<strong>KubeVela 是一个简单易用且高度可扩展的应用管理平台与核心引擎</strong>。KubeVela 是基于 Kubernetes 与 OAM 技术构建的。</p><p>详细的说，对于应用开发人员来讲，KubeVela 是一个非常低心智负担的云原生应用管理平台，核心功能是让开发人员方便快捷地在 Kubernetes 上定义与交付现代微服务应用，无需了解任何 Kubernetes 本身相关的细节。在这一点上，KubeVela 可以被认为是<strong>云原生社区的 Heroku</strong>。</p><p>另一方面，对于平台团队来讲，KubeVela 是一个强大并且高可扩展的云原生应用平台核心引擎。基于这样一个引擎，平台团队可以快速、高效地以 Kubernetes 原生的方式在 KubeVela 中植入任何来自云原生社区的应用管理能力，从而基于 KubeVela 打造出自己需要的云原生平台，比如：云原生数据库 PaaS、云原生 AI 平台、甚至 Serverless 服务。在这一点上，KubeVela 可以被认为是<strong>一个“以应用为中心”的 Kubernetes 发行版</strong>，以 OAM 为核心，让平台团队可以基于 KubeVela 快速打造出属于自己的 PaaS、Serverless 乃至任何面向用户的云原生平台项目。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-解决了什么问题？"></a>KubeVela 解决了什么问题？<a class="hash-link" href="#kubevela-解决了什么问题？" title="Direct link to heading">#</a></h2><p>现如今，云原生技术的迅猛发展可能让很多人都感觉到眼花缭乱，但实际上，这个生态的总体发展趋势和主旋律，是通过 Kubernetes 搭建了一个统一的基础设施抽象层，为平台团队屏蔽掉了“计算”、“网络”、“存储”等过去我们不得不关注的基础设施概念，使得我们能够基于 Kubernetes 方便地构建出任何我们想要的垂直业务系统而无需关心任何基础设施层的细节。这正是 Kubernetes 被称为云计算界的 Linux 以及 “Platform for Platforms” 的根本原因。</p><p>但是，当我们把视角从平台团队提升到垂直业务系统的最终用户（如：应用开发人员）的时候，我们会发现 Kubernetes 这样的定位和设计在解决了平台团队的大问题之后，却也为应用开发者们带来了挑战和困扰。比如，太多的用户都在抱怨 Kubernetes “太复杂了”。究其原因，其实在于 Kubernetes 中的核心概念与体系，如：Pod、sidecar、Service、资源管理、调度算法和 CRD 等等，主要是面向平台团队而非最终用户设计的。缺乏面向用户的设计不仅带来了陡峭的学习曲线，影响了用户的使用体验，拖慢了研发效能，甚至在很多情况下还会引发错误操作乃至生产故障（毕竟不可能每个业务开发人员都是 Kubernetes 专家）。</p><p>这也是为什么在云原生生态中，几乎每一个平台团队都会基于 Kubernetes 构建一个上层平台给用户使用。最简单的也会给 Kubernetes 做一个图形界面，稍微正式一些的则往往会基于 Kubernetes 开发一个类 PaaS 平台来满足自己的需求。理论上讲，在 Kubernetes 生态中各种能力已经非常丰富的今天，开发一个类 PaaS 平台应该是比较容易的。</p><p>然而现实却往往不尽如人意。在大量的社区访谈当中，我们发现在云原生技术极大普及的今天，基于 Kubernetes 构建一个功能完善、用户友好的上层应用平台，依然是中大型公司们的“专利”。这里的原因在于：</p><blockquote><p>Kubernetes 生态本身的能力池固然丰富，但是社区里却并没有一个可扩展的、方便快捷的方式，能够帮助平台团队把这些能力快速“组装”成面向最终用户的功能（Feature）。</p></blockquote><p>这种困境带来的结果，就是尽管大家今天都在基于 Kubernetes 在构建上层应用平台，但这些平台本质上却并不能够与 Kubernetes 生态完全打通，而都变成一个又一个的垂直“烟囱”。</p><p>在开源社区中，这个问题会更加明显。在今天的 Kubernetes 社区中，不乏各种“面向用户”、“面向应用”的 Kubernetes 上层系统。但正如前文所述，这些平台都无一例外的引入了自己的专属上层抽象、用户界面和插件机制。这里最典型的例子包括经典 PaaS 项目比如 Cloud Foundry，也包括各种 Serverless 平台。作为一个公司的平台团队，我们实际上只有两个选择：要么把自己局限在某种垂直的场景中来适配和采纳某个开源上层平台项目；要么就只能自研一个符合自己诉求的上层平台并且造无数个社区中已经存在的“轮子”。</p><p>那么，有没有”第三种选择”能够让平台团队在不造轮子、完全打通 Kubernetes 生态的前提下，轻松的构建面向用户的上层平台呢？</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-如何解决上述问题？"></a>KubeVela 如何解决上述问题？<a class="hash-link" href="#kubevela-如何解决上述问题？" title="Direct link to heading">#</a></h2><p>KubeVela 项目的创立初衷，就是以一个统一的方式同时解决上述最终用户与平台团队所面临的困境。这也是为何在设计中，KubeVela 对最终用户和平台团队这两种群体进行了单独的画像，以满足他们不同的诉求。</p><p>由于 KubeVela 默认的功能集与“Heroku”类似（即：主要面向应用开发人员），所以在下文中，我们会以应用开发人员或者开发者来代替最终用户。但我们很快也会讲到，KubeVela 里的每一个功能，都是一个插件，作为平台团队，你可以轻松地“卸载”它的所有内置能力、然后“安装”自己需要的任何社区能力，让 KubeVela 变成一个完全不一样的系统。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-应用开发者眼中的-kubevela"></a>1. 应用开发者眼中的 KubeVela<a class="hash-link" href="#1-应用开发者眼中的-kubevela" title="Direct link to heading">#</a></h3><p>前面已经提到，对于开发者来说，KubeVela 是一个简单、易用、又高可扩展的云原生应用管理工具，它可以让开发者以极低的心智负担和上手成本在 Kubernetes 上定义与部署应用。而关于整个系统的使用，开发者只需要编写一个 docker-compose 风格应用描述文件 Appfile 即可，不需要接触和学习任何 Kubernetes 层的相关细节。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1）一个-appfile-示例"></a>1）一个 Appfile 示例<a class="hash-link" href="#1）一个-appfile-示例" title="Direct link to heading">#</a></h4><p>在下述例子中，我们会将一个叫做 vela.yaml 的 Appfile 放在你的应用代码目录中（比如应用的 GitHub Repo）。这个 Appfile 定义了如何将这个应用编译成 Docker 镜像，如何将镜像部署到 Kubernetes，如何配置外界访问应用的路由和域名，又如何让 Kubernetes 自动根据 CPU 使用量来水平扩展这个应用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>只要有了这个 20 行的配置文件，你接下来唯一需要的事情就是 $ vela up，这个应用就会被部署到 Kubernetes 中然后被外界以 <a href="https://example.com/testapp" target="_blank" rel="noopener noreferrer">https://example.com/testapp</a> 的方式访问到。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2）appfile-是如何工作的？"></a>2）Appfile 是如何工作的？<a class="hash-link" href="#2）appfile-是如何工作的？" title="Direct link to heading">#</a></h4><p>在 KubeVela 的 Appfile 背后，有着非常精妙的设计。首先需要指出的就是，<strong>这个 Appfile 是没有固定的 Schema 的</strong>。</p><p>什么意思呢？这个 Appfile 里面你能够填写的每一个字段，都是直接取决于当前平台中有哪些工作负载类型（Workload Types）和应用特征（Traits）是可用的。而熟悉 OAM 的同学都知道，这两个概念，正是 OAM 规范的核心内容，其中：</p><ul><li><p><a href="https://kubevela.io/#/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">工作负载类型（Workload Type）</a>，定义的是底层基础设施如何运行这个应用。在上面的例子中，我们声明：名叫 testapp 的应用会启动一个类型为“在线 Web 服务（Web Service）” 的工作负载，其实例的名字是 express-server。</p></li><li><p><a href="https://kubevela.io/#/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">应用特征（Traits）</a>，则为工作负载实例加上了运维时配置。在上面的例子中，我们定义了一个 Route Trait 来描述应用如何被从外界访问，以及一个 Autoscale Trait 来描述应用如何根据 CPU 使用量进行自动的水平扩容。</p></li></ul><p>而正是基于这种模块化的设计，这个 Appfile 本身是高度可扩展的。当任何一个新的 Workload Type 或者 Trait 被安装到平台后，用户就可以立刻在 Appfile 里声明使用这个新增的能力。举个例子，比如后面平台团队新开发了一个用来配置应用监控属性的运维侧能力，叫做 Metrics。那么只需要举手之捞，应用开发者就可以立刻使用 $ vela show metrics 命令查看这个新增能力的详情，并且在 Appfile 中使用它，如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">metrices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/metrics&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这种简单友好、又高度敏捷的使用体验，正是 KubeVela 在最终用户侧提供的主要体感。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3）vela-up-命令"></a>3）Vela Up 命令<a class="hash-link" href="#3）vela-up-命令" title="Direct link to heading">#</a></h4><p>前面提到，一旦 Appfile 准备好，开发者只需要一句 vela up 命令就可以把整个应用连同它的运维特征部署到 Kubernetes 中。部署成功后，你可以使用 vela status 来查看整个应用的详情，包括如何访问这个应用。</p><p><img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1glf9pyhr42j20la0kiafn.jpg"></p><p>通过 KubeVela 部署的应用会被自动设置好访问 URL（以及不同版本对应的不同 URL），并且会由 cert-manager 生成好证书。与此同时，KubeVela 还提供了一系列辅助命令（比如：vela logs 和 vela exec）来帮助你在无需成为 Kubernetes 专家的情况下更好地管理和调试你的应用。如果你对上述由 KubeVela 带来的开发者体验感兴趣的话，欢迎前往 KubeVela 项目的用户使用文档来了解更多。</p><p>而接下来，我们要切换一下视角，感受一下平台团队眼中的 KubeVela 又是什么样子的。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-平台工程师眼中的-kubevela"></a>2. 平台工程师眼中的 KubeVela<a class="hash-link" href="#2-平台工程师眼中的-kubevela" title="Direct link to heading">#</a></h3><p>实际上，前面介绍到的所有开发者侧体验，都离不开 KubeVela 在平台侧进行的各种创新性设计与实现。也正是这些设计的存在，才使得 KubeVela 不是一个简单的 PaaS 或者 Serverless，<strong>而是一个可以由平台工程师扩展成任意垂直系统的云原生平台内核</strong>。</p><p>具体来说，KubeVela 为平台工程师提供了三大核心能力，使得基于 Kubernetes 构建上述面向用户的云原生平台从“阳春白雪”变成了“小菜一碟”：</p><p><strong>第一：以应用为中心</strong>。在 Appfile 背后，其实就是“应用”这个概念，它是基于 OAM 模型实现的。通过这样的方式，KubeVela 让“应用”这个概念成为了整个平台对用户暴露的核心 API。KubeVela 中的所有能力，都是围绕着“应用”展开的。这正是为何基于 KubeVela 扩展和构建出来的平台，天然是用户友好的：对于一个开发者来说，他只关心“应用”，而不是容器或者 Kubernetes；而 KubeVela 会确保构建整个平台的过程，也只与应用层的需求有关。</p><p><strong>第二：Kubernetes 原生的高可扩展性</strong>。在前面我们已经提到过，Appfile 是一个由 Workload Type 和 Trait 组成的、完全模块化的对象。而 OAM 模型的一个特点，就是任意一个 Kubernetes API 资源，都可以直接基于 Kubernetes 的 CRD 发现机制注册为一个 Workload Type 或者 Trait。这种可扩展性，使得 KubeVela 并不需要设计任何“插件系统”：<strong>KubeVela 里的每一个能力，都是插件，而整个 Kubernetes 社区，就是 KubeVela 原生的插件中心</strong>。</p><p><strong>第三：简单友好但高度可扩展的用户侧抽象体系</strong>。在了解了 Appfile 之后，你可能已经对这个对象的实现方式产生了好奇。实际上，KubeVela 中并不是简单的实现了一个 Appfile。在平台层，KubeVela 在 OAM 模型层实现中集成了CUELang 这种简洁强大的模板语言，从而为平台工程师基于 Kubernetes API 对象定义用户侧抽象（即：“最后一公里”抽象）提供了一个标准、通用的配置工具。更重要的是，平台工程师或者系统管理员，可以随时随地的每个能力对应的 CUE 模板进行修改，这些修改一旦提交到 Kubernetes，用户在 Appfile 里就可以立刻使用到新的抽象，不需要重新部署或者安装 KubeVela。</p><p>在具体实现层，KubeVela 是基于 OAM Kubernetes Runtime 构建的，同时采用 KEDA ，Flagger，Prometheus 等生态项目作为 Trait 的背后的依赖。当然，这些依赖只是 KubeVela 的选型，你可以随时为 KubeVela 定制和安装你喜欢的任何能力作为 Workload Type 或者 Trait。综合以上讲解，KubeVela 项目的整体架构由<strong>用户界面层，模型层，和能力管理层</strong>三部分组成，如下所示：</p><p><img src="https://tva2.sinaimg.cn/large/ad5fbf65gy1glf9sktkdxj20q00dsacl.jpg"></p><p>有了 KubeVela，平台工程师终于拥有了一个可以方便快捷地将任何一个 Kubernetes 社区能力封装抽象成一个面向用户的上层平台特性的强大工具。而作为这个平台的最终用户，应用开发者们只需要学习这些上层抽象，在一个配置文件中描述应用，就可以一键交付出去。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-kubevela-vs-经典-paas"></a>3. KubeVela VS 经典 PaaS<a class="hash-link" href="#3-kubevela-vs-经典-paas" title="Direct link to heading">#</a></h3><p>很多人可能会问，KubeVela 跟经典 PaaS 的主要区别和联系是什么呢？</p><p>事实上，大多数经典 PaaS 都能提供完整的应用生命周期管理功能，同时也非常关注提供简单友好的用户体验，提升研发效能。在这些点上，KubeVela 跟经典 PaaS 的目标，是非常一致的。</p><p>但另一方面，经典 PaaS 往往是不可扩展的（比如 Rancher 的 Rio 项目），或者会引入属于自己的插件生态（哪怕这个 PaaS 是完全基于 Kubernetes 构建的），以此来确保平台本身的用户体验和能力的可控制性（比如 Cloud Foundry 或者 Heroku 的<a href="https://elements.heroku.com/addons" target="_blank" rel="noopener noreferrer">插件中心</a>）。</p><p>相比之下，KubeVela 的设计是完全不同的。KubeVela 的目标，从一开始就是利用整个 Kubernetes 社区作为自己的“插件中心”，并且“故意”把它的每一个内置能力都设计成是独立的、可插拔的插件。这种高度可扩展的模型，背后其实有着精密的设计与实现。比如，KubeVela 如何确保某个完全独立的 Trait 一定能够绑定于某种 Workload Type？如何检查这些相互独立的 Trait 是否冲突？这些挑战，正是 Open Application Model（OAM）作为 KubeVela 模型层的起到的关键作用，一言以蔽之：OAM 是一个高度可扩展的应用定义与能力管理模型。</p><p>KubeVela 和 OAM 社区欢迎大家设计和制作任何 Workload Type 和 Trait 的定义文件。只要把它们存放在 GitHub 上，全世界任何一个 KubeVela 用户就都可以在自己的 Appfile 里使用你所设计的能力。具体的方式，请参考 <code>$ vela cap</code> （即：插件能力管理命令）的<a href="https://kubevela.io/#/en/developers/cap-center" target="_blank" rel="noopener noreferrer">使用文档</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="了解更多"></a>了解更多<a class="hash-link" href="#了解更多" title="Direct link to heading">#</a></h2><p>KubeVela 项目是 OAM 社区的官方项目，旨在取代原先的 Rudr 项目。不过，与 <a href="https://github.com/oam-dev/rudr" target="_blank" rel="noopener noreferrer">Rudr</a> 主要作为“参考实现”的定位不同，KubeVela 既是一个端到端、面向全量场景的 OAM Kubernetes 完整实现，同时也是阿里云 EDAS 服务和内部多个核心 PaaS/Serverless 生产系统底层的核心组件。 此外，KubeVela 中 Apppfile 的设计，也是 OAM 社区在 OAM 规范中即将引入的“面向用户侧对象”的核心部分。</p><p>如果你想要更好的了解 KubeVela 项目，欢迎前往其官方网站上<a href="https://kubevela.io/" target="_blank" rel="noopener noreferrer">学习具体的示例和手册</a>。以下也是一些非常好的学习内容和方式：</p><ul><li>前往学习 <a href="https://kubevela.io/#/en/quick-start" target="_blank" rel="noopener noreferrer">KubeVela Quick Start（新手教程）</a>，一步步了解 KubeVela 的使用方法。</li><li>前往 OAM 社区深入交流和反馈。中文：钉钉群 23310022，英文：<a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer">Gitter</a> 和 <a href="https://cloud-native.slack.com/archives/C01BLQ3HTJA" target="_blank" rel="noopener noreferrer">CNCF Slack</a>。</li><li>尝试为 <a href="https://kubevela.io/#/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">KubeVela 添加来自开源社区的插件能力</a>。此外，如果你有任何关于扩展 KubeVela 的奇妙想法，比如，基于 KubeVela 开发一个自己的云原生数据库 PaaS 或者 AI PaaS，欢迎前往 OAM 社区通过 Issue 来进行讨论。</li><li>为 KubeVela 贡献代码. KubeVela 项目是一个诞生自云原生社区的开源项目（感谢来自 8 家不同公司的<a href="https://github.com/oam-dev/kubevela/blob/bbb2c527d96d3e1a0694e2f49b3d1d1168e72c53/OWNERS_ALIASES#L35" target="_blank" rel="noopener noreferrer">初始贡献者</a>，并特别鸣谢 KubeVela 网站的发起者 <a href="https://github.com/sunny0826" target="_blank" rel="noopener noreferrer">guoxudong</a>）。 </li></ul><p><strong>KubeVela 项目的维护者会在项目稳定后，即将整个项目所有权捐赠给中立开源基金会。</strong></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div><div class="col text--right"><a aria-label="Read more about KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎" href="/zh/blog/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes"><strong>Read More</strong></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/zh/blog/extend-kubevela-by-cuelang-in-20-mins">如何在 20 分钟内给你的 K8s PaaS 上线一个新功能</a></h2><div class="margin-vert--md"><time datetime="2021-04-30T02:06:04.272Z" class="blogPostDate_fNvV">April 30, 2021 · One min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/wonderflow" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/2173670?s=200&amp;v=4" alt="wonderflow"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/wonderflow" target="_blank" rel="noopener noreferrer">wonderflow</a></h4><small class="avatar__subtitle">OAM/KubeVela maintainer</small></div></div></header><div class="markdown"><blockquote><p>2020年12月14日 19:33, by @wonderflow</p></blockquote><p>上个月，<a href="https://kubevela.io/#/blog/zh/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes" target="_blank" rel="noopener noreferrer">KubeVela 正式发布</a>了，
作为一款简单易用且高度可扩展的应用管理平台与核心引擎，可以说是广大平台工程师用来构建自己的云原生 PaaS 的神兵利器。
那么本文就以一个实际的例子，讲解一下如何在 20 分钟内，为你基于 KubeVela 的 PaaS “上线“一个新能力。</p><p>在正式开始本文档的教程之前，请确保你本地已经正确<a href="https://kubevela.io/#/en/install" target="_blank" rel="noopener noreferrer">安装了 KubeVela</a> 及其依赖的 K8s 环境。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-扩展的基本结构"></a>KubeVela 扩展的基本结构<a class="hash-link" href="#kubevela-扩展的基本结构" title="Direct link to heading">#</a></h1><p>KubeVela 的基本架构如图所示：</p><p><img src="https://kubevela-docs.oss-cn-beijing.aliyuncs.com/kubevela-extend.jpg" alt="image"></p><p>简单来说，KubeVela 通过添加 <strong>Workload Type</strong> 和 <strong>Trait</strong> 来为用户扩展能力，平台的服务提供方通过 Definition 文件注册和扩展，向上通过 Appfile 透出扩展的功能。官方文档中也分别给出了基本的编写流程，其中2个是Workload的扩展例子，一个是Trait的扩展例子：</p><ul><li><a href="https://kubevela.io/#/en/platform-engineers/workload-type" target="_blank" rel="noopener noreferrer">OpenFaaS 为例的 Workload Type 扩展</a></li><li><a href="https://kubevela.io/#/en/platform-engineers/cloud-services" target="_blank" rel="noopener noreferrer">云资源 RDS 为例的 Workload Type 扩展</a></li><li><a href="https://kubevela.io/#/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">KubeWatch 为例的 Trait 扩展</a></li></ul><p>我们以一个内置的 WorkloadDefinition 为例来介绍一下 Definition 文件的基本结构：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">definition.oam.dev/description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &quot;`Webservice` is a workload type to describe long</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scalable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> containerized services that have a stable network endpoint to receive external network traffic from customers.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    If workload type is skipped for any service defined in Appfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> it will be defaulted to `Web Service` type.&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">extension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                &quot;app.oam.dev/component&quot;: context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    &quot;app.oam.dev/component&quot;: context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        name:  context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;cmd&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            command: parameter.cmd</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;env&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            env: parameter.env</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if context[&quot;config&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            env: context.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        ports: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            containerPort: parameter.port</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;cpu&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            resources: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                limits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                    cpu: parameter.cpu</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                requests:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                    cpu: parameter.cpu</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            }}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        // +usage=Which image would you like to use for your service</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        // +short=i</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        image: string</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Commands to run in the container</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cmd?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Which port do you want customer traffic sent to</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +short=p</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">*80</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> int</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Define arguments by using environment variables</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">env?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=Environment variable name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=The value of the environment variable</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">value?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=Specifies a source the value of this var should come from</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">valueFrom?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                // +usage=Selects a key of a secret in the pod&#x27;s namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    // +usage=The name of the secret in the pod&#x27;s namespace to select from</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    // +usage=The key of the secret to select from. Must be a valid secret key</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Number of CPU units for the service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> like `0.5` (0.5 CPU core)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> `1` (1 CPU core)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpu?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>乍一看挺长的，好像很复杂，但是不要着急，其实细看之下它分为两部分：</p><ul><li>不含扩展字段的 Definition 注册部分。</li><li>供 Appfile 使用的扩展模板（CUE Template）部分 </li></ul><p>我们拆开来慢慢介绍，其实学起来很简单。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="不含扩展字段的-definition-注册部分"></a>不含扩展字段的 Definition 注册部分<a class="hash-link" href="#不含扩展字段的-definition-注册部分" title="Direct link to heading">#</a></h1><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">definition.oam.dev/description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &quot;`Webservice` is a workload type to describe long</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scalable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> containerized services that have a stable network endpoint to receive external network traffic from customers.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    If workload type is skipped for any service defined in Appfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> it will be defaulted to `Web Service` type.&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这一部分满打满算11行，其中有3行是在介绍 <code>webservice</code>的功能，5行是固定的格式。只有2行是有特定信息：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这两行的意思代表了这个Definition背后用的CRD名称是什么，其格式是 <code>&lt;resources&gt;.&lt;api-group&gt;</code>.了解 K8s 的同学应该知道 K8s 中比较常用的是通过 <code>api-group</code>, <code>version</code> 和 <code>kind</code> 定位资源，而 <code>kind</code> 在 K8s restful API 中对应的是 <code>resources</code>。以大家熟悉 <code>Deployment</code> 和 <code>ingress</code> 为例，它的对应关系如下：</p><table><thead><tr><th>api-group</th><th>kind</th><th>version</th><th>resources</th></tr></thead><tbody><tr><td>apps</td><td>Deployment</td><td>v1</td><td>deployments</td></tr><tr><td>networking.k8s.io</td><td>Ingress</td><td>v1</td><td>ingresses</td></tr></tbody></table><blockquote><p>这里补充一个小知识，为什么有了 kind 还要加个 resources 的概念呢？
因为一个 CRD 除了 kind 本身还有一些像 status，replica 这样的字段希望跟 spec 本身解耦开来在 restful API 中单独更新，
所以 resources 除了 kind 对应的那一个，还会有一些额外的 resources，如 Deployment 的 status 表示为 <code>deployments/status</code>。</p></blockquote><p>所以相信聪明的你已经明白了不含 extension 的情况下，Definition应该怎么写了，最简单的就是根据 K8s 的资源组合方式拼接一下，只要填下面三个尖括号的空格就可以了。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写名称</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">.&lt;这里写api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>针对运维特征注册（TraitDefinition）也是这样。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> TraitDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写名称</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">.&lt;这里写api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>所以把 <code>Ingress</code> 作为 KubeVela 的扩展写进去就是：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> TraitDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingresses.networking.k8s.io</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>除此之外，TraitDefinition 中还增加了一些其他功能模型层功能，如：</p><ul><li><code>appliesToWorkloads</code>: 表示这个 trait 可以作用于哪些 Workload 类型。</li><li><code>conflictWith</code>： 表示这个 trait 和哪些其他类型的 trait 有冲突。</li><li><code>workloadRefPath</code>： 表示这个 trait 包含的 workload 字段是哪个，KubeVela 在生成 trait 对象时会自动填充。
... </li></ul><p>这些功能都是可选的，本文中不涉及使用，在后续的其他文章中我们再给大家详细介绍。</p><p>所以到这里，相信你已经掌握了一个不含 extensions 的基本扩展模式，而剩下部分就是围绕 <a href="https://cuelang.org/" target="_blank" rel="noopener noreferrer">CUE</a> 的抽象模板。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="供-appfile-使用的扩展模板（cue-template）部分"></a>供 Appfile 使用的扩展模板（CUE Template）部分<a class="hash-link" href="#供-appfile-使用的扩展模板（cue-template）部分" title="Direct link to heading">#</a></h1><p>对 CUE 本身有兴趣的同学可以参考这篇<a href="https://wonderflow.info/posts/2020-12-15-cuelang-template/" target="_blank" rel="noopener noreferrer">CUE 基础入门</a> 多做一些了解，限于篇幅本文对 CUE 本身不详细展开。</p><p>大家知道 KubeVela 的 Appfile 写起来很简洁，但是 K8s 的对象是一个相对比较复杂的 YAML，而为了保持简洁的同时又不失可扩展性，KubeVela 提供了一个从复杂到简洁的桥梁。
这就是 Definition 中 CUE Template 的作用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cue-格式模板"></a>CUE 格式模板<a class="hash-link" href="#cue-格式模板" title="Direct link to heading">#</a></h2><p>让我们先来看一个 Deployment 的 YAML 文件，如下所示，其中很多内容都是固定的框架（模板部分），真正需要用户填的内容其实就少量的几个字段（参数部分）。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> apps/v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Deployment</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">meadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> a</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> b</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">app.oam.dev/component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">app.oam.dev/component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 KubeVela 中，Definition 文件的固定格式就是分为 <code>output</code> 和 <code>parameter</code> 两部分。其中<code>output</code>中的内容就是“模板部分”，而 <code>parameter</code> 就是参数部分。</p><p>那我们来把上面的 Deployment YAML 改写成 Definition 中模板的格式。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cue"><div tabindex="0" class="prism-code language-cue codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    metadata: name: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;app.oam.dev/component&quot;: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;app.oam.dev/component&quot;: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: &quot;nginx:v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env: [{name:&quot;a&quot;,value:&quot;b&quot;}]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这个格式跟 json 很像，事实上这个是 CUE 的格式，而 CUE 本身就是一个 json 的超集。也就是说，CUE的格式在满足 JSON 规则的基础上，增加了一些简便规则，
使其更易读易用：</p><ul><li>C 语言的注释风格。</li><li>表示字段名称的双引号在没有特殊符号的情况下可以缺省。</li><li>字段值结尾的逗号可以缺省，在字段最后的逗号写了也不会出错。</li><li>最外层的大括号可以省略。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cue-格式的模板参数--变量引用"></a>CUE 格式的模板参数--变量引用<a class="hash-link" href="#cue-格式的模板参数--变量引用" title="Direct link to heading">#</a></h2><p>编写好了模板部分，让我们来构建参数部分，而这个参数其实就是变量的引用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>如上面的这个例子所示，KubeVela 中的模板参数就是通过 <code>parameter</code> 这个部分来完成的，而<code>parameter</code> 本质上就是作为引用，替换掉了 <code>output</code> 中的某些字段。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完整的-definition-以及在-appfile-使用"></a>完整的 Definition 以及在 Appfile 使用<a class="hash-link" href="#完整的-definition-以及在-appfile-使用" title="Direct link to heading">#</a></h2><p>事实上，经过上面两部分的组合，我们已经可以写出一个完整的 Definition 文件：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">extension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>为了方便调试，一般情况下可以预先分为两个文件，一部分放前面的 yaml 部分，假设命名为 <code>def.yaml</code> 如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kind: WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  name: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  definitionRef:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  extension:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    template: </span><span class="token operator">|</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>另一个则放 cue 文件，假设命名为 <code>def.cue</code> ：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;apps/v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deployment&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app.oam.dev/component&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app.oam.dev/component&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>先对 <code>def.cue</code> 做一个格式化，格式化的同时 cue 工具本身会做一些校验，也可以更深入的<a href="https://wonderflow.info/posts/2020-12-15-cuelang-template/" target="_blank" rel="noopener noreferrer">通过 cue 命令做调试</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">cue </span><span class="token function" style="color:rgb(80, 250, 123)">fmt</span><span class="token plain"> def.cue</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>调试完成后，可以通过脚本把这个 yaml 组装：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">./hack/vela-templates/mergedef.sh def.yaml def.cue </span><span class="token operator">&gt;</span><span class="token plain"> mydeploy.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>再把这个 yaml 文件 apply 到 K8s 集群中。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl apply -f mydeploy.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">workloaddefinition.core.oam.dev/mydeploy created</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>一旦新能力 <code>kubectl apply</code> 到了 Kubernetes 中，不用重启，也不用更新，KubeVela 的用户可以立刻看到一个新的能力出现并且可以使用了：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela worklaods</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Automatically discover capabilities successfully ✅ Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Delete</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">TYPE        CATEGORY    DESCRIPTION</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+mydeploy   workload    description not defined</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME        DESCRIPTION</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">mydeploy    description not defined</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 Appfile 中使用方式如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">extend</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">mysvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> crccheck/hello</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>执行 <code>vela up</code> 就能把这个运行起来了：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela up -f docs/examples/blog-extension/my-extend-app.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Parsing vela appfile </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Loading templates </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Rendering configs </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mysvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Writing deploy config to </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">.vela/deploy.yaml</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Applying deploy configs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Checking </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> app has been deployed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">App has not been deployed, creating a new deployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">✅ App has been deployed 🚀🚀🚀</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Port forward: vela port-forward my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             SSH: vela </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Logging: vela logs my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      App status: vela status my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Service status: vela status my-extend-app --svc mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>我们来查看一下应用的状态，已经正常运行起来了（<code>HEALTHY Ready: 1/1</code>）：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela status my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">About:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Name:         my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Namespace:    env-application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Created at:   </span><span class="token number">2020</span><span class="token plain">-12-15 </span><span class="token number">16</span><span class="token plain">:32:25.08233 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Updated at:   </span><span class="token number">2020</span><span class="token plain">-12-15 </span><span class="token number">16</span><span class="token plain">:32:25.08233 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    HEALTHY Ready: </span><span class="token number">1</span><span class="token plain">/1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="definition-模板中的高级用法"></a>Definition 模板中的高级用法<a class="hash-link" href="#definition-模板中的高级用法" title="Direct link to heading">#</a></h1><p>上面我们已经通过模板替换这个最基本的功能体验了扩展 KubeVela 的全过程，除此之外，可能你还有一些比较复杂的需求，如条件判断，循环，复杂类型等，需要一些高级的用法。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="结构体参数"></a>结构体参数<a class="hash-link" href="#结构体参数" title="Direct link to heading">#</a></h2><p>如果模板中有一些参数类型比较复杂，包含结构体和嵌套的多个结构体，就可以使用结构体定义。</p><ol><li>定义一个结构体类型，包含1个字符串成员、1个整型和1个结构体成员。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">#Config: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    value: int</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    other: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      key: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>在变量中使用这个结构体类型，并作为数组使用。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config: [...#Config]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>同样的目标中也是以变量引用的方式使用。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env: parameter.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="4"><li>Appfile 中的写法就是按照 parameter 定义的结构编写。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: crccheck/hello-world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: a</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: 1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      other:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        key: mykey</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        value: myvalue</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="条件判断"></a>条件判断<a class="hash-link" href="#条件判断" title="Direct link to heading">#</a></h2><p>有时候某些参数加还是不加取决于某个条件：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:   string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    useENV: bool</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> parameter.useENV </span><span class="token operator">==</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">name: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-env&quot;</span><span class="token plain">, value: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-value&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 Appfile 就是写值。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: crccheck/hello-world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    useENV: true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="可缺省参数"></a>可缺省参数<a class="hash-link" href="#可缺省参数" title="Direct link to heading">#</a></h2><p>有些情况下参数可能存在也可能不存在，即非必填，这个时候一般要配合条件判断使用，对于某个字段不存在的情况，判断条件是是 <code>_variable != _|_</code>。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config?: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token comment" style="color:rgb(98, 114, 164)">#Config]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> parameter.config </span><span class="token operator">!=</span><span class="token plain"> _</span><span class="token operator">|</span><span class="token plain">_ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                config: parameter.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这种情况下 Appfile 的 config 就非必填了，填了就渲染，没填就不渲染。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="默认值"></a>默认值<a class="hash-link" href="#默认值" title="Direct link to heading">#</a></h2><p>对于某些参数如果希望设置一个默认值，可以采用这个写法。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: *</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;nginx:v1&quot;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这个时候 Appfile 就可以不写 image 这个参数，默认使用 &quot;nginx:v1&quot;：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="循环"></a>循环<a class="hash-link" href="#循环" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="map-类型的循环"></a>Map 类型的循环<a class="hash-link" href="#map-类型的循环" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> k, </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> parameter.env </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  k</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    value: </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Appfile 中的写法：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  &quot;mysvc&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: &quot;nginx&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      env1: value1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      env2: value2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="数组类型的循环"></a>数组类型的循环<a class="hash-link" href="#数组类型的循环" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">name:string,value:string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> _, </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> parameter.env </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  v.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    value: v.value</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Appfile 中的写法：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  &quot;mysvc&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: &quot;nginx&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: env1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: value1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: env2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: value2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-内置的-context-变量"></a>KubeVela 内置的 <code>context</code> 变量<a class="hash-link" href="#kubevela-内置的-context-变量" title="Direct link to heading">#</a></h2><p>大家可能也注意到了，我们在 parameter 中定义的 name 每次在 Appfile中 实际上写了两次，一次是在 services 下面（每个service都以名称区分），
另一次则是在具体的<code>name</code>参数里面。事实上这里重复的不应该由用户再写一遍，所以 KubeVela 中还定义了一个内置的 <code>context</code>，里面存放了一些通用的环境上下文信息，如应用名称、秘钥等。
直接在模板中使用 context 就不需要额外增加一个 <code>name</code> 参数了， KubeVela 在运行渲染模板的过程中会自动传入。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-中的注释增强"></a>KubeVela 中的注释增强<a class="hash-link" href="#kubevela-中的注释增强" title="Direct link to heading">#</a></h2><p>KubeVela 还对 cuelang 的注释做了一些扩展，方便自动生成文档以及被 CLI 使用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"> parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Which image would you like to use for your service</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +short=i</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Commands to run in the container</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        cmd?: [...string]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>其中，<code>+usgae</code> 开头的注释会变成参数的说明，<code>+short</code> 开头的注释后面则是在 CLI 中使用的缩写。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h1><p>本文通过实际的案例和详细的讲述，为你介绍了在 KubeVela 中新增一个能力的详细过程与原理，以及能力模板的编写方法。</p><p>这里你可能还有个疑问，平台管理员这样添加了一个新能力后，平台的用户又该怎么能知道这个能力怎么使用呢？其实，在 KubeVela 中，它不仅能方便的添加新能力，<strong>它还能自动为“能力”生成 Markdown 格式的使用文档！</strong> 不信，你可以看下 KubeVela 本身的官方网站，所有在 <code>References/Capabilities</code>目录下能力使用说明文档（比如<a href="https://kubevela.io/#/en/developers/references/workload-types/webservice" target="_blank" rel="noopener noreferrer">这个</a>），全都是根据每个能力的模板自动生成的哦。
最后，欢迎大家写一些有趣的扩展功能，提交到 KubeVela 的<a href="https://github.com/oam-dev/catalog/tree/master/registry" target="_blank" rel="noopener noreferrer">社区仓库</a>中来。 </p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div><div class="col text--right"><a aria-label="Read more about 如何在 20 分钟内给你的 K8s PaaS 上线一个新功能" href="/zh/blog/extend-kubevela-by-cuelang-in-20-mins"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/install">快速开始</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/platform-engineers/overview">Platform Builder Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start-appfile">Developer Experience Guide</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #kubevela channel )</a></li><li class="footer__item"><a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog/tags/">DingTalk (23310022)</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© KubeVela Authors 2021 | Documentation Distributed under <a herf="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a> </strong> <strong>| Powered by <a href="https://www.netlify.com">Netlify</a></strong>
        <br>
      </div></div></div></footer></div>
<script src="/zh/assets/js/styles.3f20afd4.js"></script>
<script src="/zh/assets/js/runtime~main.53cad828.js"></script>
<script src="/zh/assets/js/main.df960407.js"></script>
<script src="/zh/assets/js/1.89bb97b5.js"></script>
<script src="/zh/assets/js/2.462ea471.js"></script>
<script src="/zh/assets/js/3.d316d69f.js"></script>
<script src="/zh/assets/js/6875c492.8f6bf776.js"></script>
<script src="/zh/assets/js/34dd6e82.7ede88ae.js"></script>
<script src="/zh/assets/js/111d754a.48e6ce57.js"></script>
<script src="/zh/assets/js/33713896.81b19419.js"></script>
<script src="/zh/assets/js/dcd7855b.5fbb5881.js"></script>
</body>
</html>